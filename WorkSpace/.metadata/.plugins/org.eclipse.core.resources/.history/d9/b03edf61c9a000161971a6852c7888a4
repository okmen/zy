package com.egou.search.lucene;

import java.util.Set;

import org.apache.lucene.index.IndexReader;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.TrackingIndexWriter;
import org.apache.lucene.search.ControlledRealTimeReopenThread;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.ReferenceManager;
import org.apache.lucene.search.SearcherFactory;
import org.apache.lucene.search.SearcherManager;
import org.apache.lucene.store.Directory;
import org.apache.lucene.util.Version;

public class LuceneCommon {
	
	/**
	 * lucene版本
	 */
	static Version Lucene_Version = Version.LUCENE_4_10_4;
	/**
	 * 索引文件地址
	 */
	Directory directory = null;
	/**
	 * 写入索引
	 */
	IndexWriter writer = null;
	/**
	 * 读取索引文件
	 */
	IndexReader reader;
	/**
	 *  读入停用词文件 路径
	 */
	String stopWordTablePath;
	/**
	 * 读入停用词文件名称
	 */
	String stopWordTablename = "ChineseStopWord.txt";
	
	/** nrt init **/
	private TrackingIndexWriter trackingIndexWriter = null;
	private ReferenceManager<IndexSearcher> reMgr = null;// 绫讳技浜Lucene3.x涓NrtManager
	private ControlledRealTimeReopenThread<IndexSearcher> crt = null;
//	private Log logger = LogFactory.getLog(this.getClass());
	private Set<String> stopWordSet = null;
	
	
	public void init() {
		if (crt == null) {
			try {
				initStopWord();
				directory = new FileIndexUtils().getDirectory();
				if (IndexWriter.isLocked(directory)) {
					IndexWriter.unlock(directory);
				}
				// Analyzer analyzer=new StandardAnalyzer(Version.LUCENE_46);
				writer = new IndexWriter(directory, new IndexWriterConfig(Lucene_Version, AnalyzerUtil.getIkAnalyzer()));
				trackingIndexWriter = new TrackingIndexWriter(writer);
				reMgr = new SearcherManager(writer, true, new SearcherFactory());
				/** 在0.025s~5.0s之间重启一次线程，这个是时间的最佳实践 **/
				crt = new ControlledRealTimeReopenThread<>(trackingIndexWriter, reMgr, 5.0, 0.025);
				crt.setDaemon(true);// 设置为后台服务
				crt.setName("Index update to disk");// 线程名称
				crt.start();// 线程启动

			} catch (Exception e) {
				System.out.println("Lucene初始化失败：" + e.getMessage());
				e.printStackTrace();
			}
		}
	}
}
