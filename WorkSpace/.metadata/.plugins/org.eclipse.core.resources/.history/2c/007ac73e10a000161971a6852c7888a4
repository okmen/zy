package com.egou.search.lucene;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.lucene.document.Document;
import org.apache.lucene.document.DoubleField;
import org.apache.lucene.document.IntField;
import org.apache.lucene.document.LongField;
import org.apache.lucene.document.StringField;
import org.apache.lucene.document.TextField;
import org.apache.lucene.document.Field.Store;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.Term;
import org.apache.lucene.index.TrackingIndexWriter;
import org.apache.lucene.search.BooleanClause.Occur;
import org.apache.lucene.search.BooleanQuery;
import org.apache.lucene.search.ControlledRealTimeReopenThread;
import org.apache.lucene.search.FieldCache;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.NumericRangeQuery;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.ReferenceManager;
import org.apache.lucene.search.ScoreDoc;
import org.apache.lucene.search.SearcherFactory;
import org.apache.lucene.search.SearcherManager;
import org.apache.lucene.search.Sort;
import org.apache.lucene.search.SortField;
import org.apache.lucene.search.TermQuery;
import org.apache.lucene.search.TopDocs;
import org.apache.lucene.search.TopScoreDocCollector;
import org.apache.lucene.search.WildcardQuery;
import org.apache.lucene.search.highlight.Formatter;
import org.apache.lucene.search.highlight.Fragmenter;
import org.apache.lucene.search.highlight.Highlighter;
import org.apache.lucene.search.highlight.InvalidTokenOffsetsException;
import org.apache.lucene.search.highlight.QueryScorer;
import org.apache.lucene.search.highlight.SimpleHTMLFormatter;
import org.apache.lucene.search.highlight.SimpleSpanFragmenter;
import org.apache.lucene.store.Directory;
import org.apache.lucene.util.Version;
import org.springframework.beans.factory.annotation.Autowired;
import org.wltea.analyzer.core.IKSegmenter;
import org.wltea.analyzer.core.Lexeme;

import com.egou.search.service.ILuceneSerive;
import com.egou.search.vo.ProductIndex;



public class NearRealTimeSearch {
	private static Version Lucene_Version = Version.LUCENE_4_10_4;
	
	@Autowired
	private ILuceneSerive service;
	
	private Directory directory = null;
	private IndexWriter writer = null;

	/** nrt init **/
	private TrackingIndexWriter trackingIndexWriter = null;
	private ReferenceManager<IndexSearcher> reMgr = null;// 绫讳技浜嶭ucene3.x涓殑NrtManager
	private ControlledRealTimeReopenThread<IndexSearcher> crt = null;
	private Log logger = LogFactory.getLog(this.getClass());   
	private String stopWordTable="";
	private  Set<String> stopWordSet=null;
	// 鏁版嵁鍒濆鍖�
	public NearRealTimeSearch() {

	}

	public void initStopWord()
	{
		try
		{
			//璇诲叆鍋滅敤璇嶆枃浠�  
	        BufferedReader StopWordFileBr = new BufferedReader(new InputStreamReader(new FileInputStream(new File(stopWordTable)))); 
			 //鐢ㄦ潵瀛樻斁鍋滅敤璇嶇殑闆嗗悎  
	        stopWordSet = new HashSet<String>();  
	        //鍒濆鍖栧仠鐢ㄨ瘝闆�  
	        String stopWord = null;  
	        for(; (stopWord = StopWordFileBr.readLine()) != null;){  
	            stopWordSet.add(stopWord);  
	        }  	       
	        //鍏抽棴娴�  
	        StopWordFileBr.close(); 	
		}
		catch(Exception ex)
		{
			
		}
	}
	
	public void init() {
		if (crt == null)
		{
			try 
			{
				initStopWord();
				stopWordTable=getClass().getClassLoader().getResource("ChineseStopWord.txt").getPath() ;
				directory = new  FileIndexUtils().getDirectory();	
				if(IndexWriter.isLocked(directory))
					IndexWriter.unlock(directory);
				writer = new IndexWriter(directory, new IndexWriterConfig(Lucene_Version, AnalyzerUtil.getIkAnalyzer()));				
				trackingIndexWriter = new TrackingIndexWriter(writer);
				reMgr = new SearcherManager(writer, true, new SearcherFactory());
				/** 鍦�0.025s~5.0s涔嬮棿閲嶅惎涓�娆＄嚎绋嬶紝杩欎釜鏄椂闂寸殑鏈�浣冲疄璺� **/
				crt = new ControlledRealTimeReopenThread<>(trackingIndexWriter,
						reMgr, 5.0, 0.025);
				crt.setDaemon(true);// 璁剧疆涓哄悗鍙版湇鍔�
				crt.setName("Index update to disk");// 绾跨▼鍚嶇О
				crt.start();// 绾跨▼鍚姩

			} catch (Exception e) {
				logger.error("Lucene鍒濆鍖栧け璐ワ細"+e.getMessage());
				
				e.printStackTrace();
			}
		}
	}

	/**
	 * 瀹氭湡鎻愪氦鍐呭瓨涓緱绱㈠紩鍒扮‖鐩樹笂锛岄槻姝涪澶�
	 */
	public void commit() {
		try {
			writer.commit();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	/**
	 * 寤虹珛绱㈠紩 瑕佸疄鐜皊earch nrt,闇�瑕佷娇鐢═rackIndexWriter淇濆瓨document锛屽悓鏃禬riter涔熶笉闇�瑕佸叧闂��
	 * 
	 * **/
	public void index(List<ProductIndex> ids) throws IOException {

		try {
			for (int i = 0; i < ids.size(); i++) 
			{
				Document doc = new Document();
				ProductIndex ldata = ids.get(i);
				try 
				{					
					doc.add(new StringField("id", ldata.getProductid().toString(), Store.YES)); 
					doc.add(new TextField("content", ldata.getTitle(),Store.YES)); 
					
					
					if(trackingIndexWriter==null)
					{
						logger.warn("Lucene鍒涘缓绱㈠紩鏃跺紓甯革紝trackingIndexWriter涓虹┖锛�");
						init();
					}
					trackingIndexWriter.addDocument(doc);
				} 
				catch (Exception ex)
				{
					logger.error("Lucene鍒涘缓绱㈠紩鏃跺紓甯�:"+ex.getMessage());
					continue;
				}
			}
		} finally {
			commit();// 棣栨鍒涘缓锛屾彁浜ょ储寮�,鍙湁鎻愪氦鍚庯紝鎵嶄細鍦ㄧ储寮曠墖娈典腑涔熷皢淇℃伅鏀瑰彉
			
		}

	}

	/*** 鏌ヨ **/
	public void query() {
		IndexSearcher is = getSearcher();
		try {
			// 閫氳繃reader鍙互鏈夋晥鐨勮幏鍙栧埌鏂囨。鐨勬暟閲�
			System.out.println("numDocs:" + is.getIndexReader().numDocs());
			System.out.println("maxDocs:" + is.getIndexReader().maxDoc());
			System.out.println("deleteDocs:"
					+ is.getIndexReader().numDeletedDocs());
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				reMgr.release(is);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}

	/**
	 * 鍒犻櫎 浣跨敤trackIndexWriter杩涜鏁版嵁鍒犻櫎锛屼篃涓嶉渶瑕佸叧闂璚riter
	 * **/
	public void delete(String productid) {
		try {			
			
			trackingIndexWriter.deleteDocuments(new Term("id", productid));
		} catch (Exception e) {
			logger.error("Lucene鍒犻櫎绱㈠紩鏃跺紓甯�:"+e.getMessage());
			e.printStackTrace();
		}
	}

	/**
	 * 淇敼 浣跨敤trackIndexWriter杩涜淇敼锛屼笉闇�瑕佸叧闂瓀riter
	 * **/
	public void update(LuceneData ldata) {
		try {
			Document doc = new Document();
			/*
			 * Lucene骞舵病鏈夋彁渚涙洿鏂帮紝杩欓噷鐨勬洿鏂版搷浣滃叾瀹炴槸濡備笅涓や釜鎿嶄綔鐨勫悎闆� 鍏堝垹闄や箣鍚庡啀娣诲姞
			 */
			doc.add(new StringField("id", ldata.getId().toString(), Store.YES)); //productid
			doc.add(new LongField("supWeiID", ldata.getSupWeiID()==null?0L:ldata.getSupWeiID(),Store.YES));//渚涘簲鍟唅d
			doc.add(new TextField("content", ldata.getProtitle(),Store.YES)); //浜у搧鏍囬
			doc.add(new TextField("supWeiName", ldata.getSupWeiName(),Store.YES)); //渚涘簲鍟嗗悕绉�
			doc.add(new StringField("supType", ldata.getSupType()==null?"":ldata.getSupType(),Store.YES)); //渚涘簲鍟嗙被鍨�
			// 瀛樺偍鏁板瓧
			doc.add(new IntField("btypeid", ldata.getBigtype(), Store.YES));//涓�绾у垎绫�
			doc.add(new IntField("mtypeid", ldata.getMediatype(), Store.YES));//浜岀骇鍒嗙被
			doc.add(new IntField("stypeid", ldata.getSmalltype(), Store.YES));//涓夌骇鍒嗙被
			doc.add(new IntField("brandid", ldata.getBrandid(), Store.YES));//鍝佺墝ID
			
			doc.add(new IntField("marketId",ldata.getMarketId(),Store.YES));
			doc.add(new IntField("sellType", ldata.getSellType(),Store.YES));
			doc.add(new IntField("yu", ldata.getYu(), Store.YES));
			doc.add(new IntField("pi", ldata.getPi(), Store.YES));
			doc.add(new IntField("ling",ldata.getLing(),Store.YES));
			doc.add(new LongField("hot", ldata.getHot()==null?0L:ldata.getHot(), Store.YES));
			// 瀛樺偍鏃ユ湡
			doc.add(new StringField("createTime", ldata.getCreateTime()+"",Store.YES));
			doc.add(new IntField("clickPoint", ldata.getClickPoint()==null ? 0:Integer.parseInt(ldata.getClickPoint().toString()),Store.YES));
			doc.add(new DoubleField("defaultPrice", ldata.getDefaultPrice()==null?0.0:ldata.getDefaultPrice(), Store.YES));
			doc.add(new DoubleField("defaultCommision", ldata.getDefaultCommision()==null?0.0:ldata.getDefaultCommision(), Store.YES));
			doc.add(new DoubleField("startPrice",ldata.getStartPrice()==null?0.0:ldata.getStartPrice(), Store.YES));
			doc.add(new DoubleField("endPrice", ldata.getEndPrice()==null?0.0:ldata.getEndPrice(),Store.YES));
			doc.add(new IntField("totalCount", ldata.getSellCount(), Store.YES));
			doc.add(new IntField("evaluateCount", ldata.getEvaluateCount(), Store.YES));
			doc.add(new IntField("shelvesCount", ldata.getShelvesCount(), Store.YES));
			
			trackingIndexWriter.updateDocument(new Term("id", ldata.getId().toString()), doc);
		} catch (Exception e) {
			logger.error("Lucene鏇存柊绱㈠紩鏃跺紓甯�:"+e.getMessage());
			service.insertErrorIndex(ldata.getId(),(short)1);
			e.printStackTrace();
		}
	}

	public  Map<String, Object>   searchHitCount(String text, String sweiName,int btype,int mtype,int stype,Double startprice,Double endprice,
			String where,String wheretype,String marketId,int brandid, Integer page, Integer pageSize)
	{
		IndexSearcher is = getSearcher();
		try {
			Map<String, Object> map = new HashMap<String, Object>();
			// ----------璁剧疆杩囨护鍣�------------------------------------------------
			BooleanQuery booleanquery = new BooleanQuery();
			BooleanQuery hitQuery= new BooleanQuery();
			 if(stopWordSet == null || stopWordSet.size()<=0)
				 initStopWord();
	        //鍒涘缓鍒嗚瘝瀵硅薄  
	        StringReader sr=new StringReader(text);    
	        IKSegmenter ik=new IKSegmenter(sr, false);    
	        Lexeme lex=null;    
	        //鍒嗚瘝  	        
	        if(text.length()>0)
	        {
		        while((lex=ik.next())!=null){  
		            //鍘婚櫎鍋滅敤璇�  
		            if(stopWordSet.contains(lex.getLexemeText())) {  
		                continue;  
		            }  
		            Query likequery = new TermQuery(new Term("content",lex.getLexemeText()));
					booleanquery.add(likequery, Occur.SHOULD);
					hitQuery.add(likequery, Occur.SHOULD);   
		        }   
	        }
	        else
	        {
	        	Query likequery= new WildcardQuery(new Term("content","*"));
	        	booleanquery.add(likequery,Occur.MUST);
	        }
	        
	        //搴楅摵鎼滅储
	        if(sweiName!=null &&!"".equals(sweiName)&&sweiName.length()>0)
	        {
	        	Query likequery = new TermQuery(new Term("supWeiName",sweiName));
				booleanquery.add(likequery, Occur.SHOULD);
				hitQuery.add(likequery, Occur.SHOULD);  
	        }
	        if(startprice !=null || endprice !=null)
	        {
	        	if(startprice == null)
	        		startprice=0.0;
	        	if(endprice == null)
	        		endprice = 0.0;
	        	Query subquery = NumericRangeQuery.newDoubleRange("defaultPrice", startprice,  endprice, true, true);
				booleanquery.add(subquery, Occur.MUST);
	        }
			// 涓�绾у垎绫� 锛堟煡璇㈡潯浠�2锛�
			if (btype > 0) {
				Query subquery = NumericRangeQuery.newIntRange("btypeid", btype,  btype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			// 浜岀骇鍒嗙被
			if (mtype > 0) {
				Query subquery = NumericRangeQuery.newIntRange("mtypeid", mtype,  mtype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			//涓夌骇鍒嗙被
			if(stype>0)
			{
				Query subquery = NumericRangeQuery.newIntRange("stypeid", stype,  stype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if(brandid>0)
			{
				Query subquery = NumericRangeQuery.newIntRange("brandid", stype,  stype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			//鏌ヨ甯傚満id
			if (marketId.length() > 0) {
				Query subquery = NumericRangeQuery.newIntRange("marketId", Integer.parseInt(marketId),  Integer.parseInt(marketId), true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if("yu".equals(wheretype)) //鏀寔棰勫畾
			{
				Query subquery = NumericRangeQuery.newIntRange("yu",1,  1, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if("pi".equals(wheretype)) //鏀寔鎵瑰彂
			{
				Query subquery =  NumericRangeQuery.newIntRange("pi",1,  1, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}	
			TopDocs topDocs = is.search(booleanquery, 2000,null);  // 鎼滅储鐩镐技搴︽渶楂樼殑N鏉¤褰�
			int totalNum=topDocs.totalHits;
			map.put("totalCount", totalNum);
			map.put("totalPage", totalNum / pageSize
					+ (totalNum % pageSize == 0 ? 0 : 1));
			map.put("pageIndex", page);
			map.put("pageSize", pageSize);
			return map;
		} catch (IOException e) {
			logger.error("Lucene鏌ヨ鏃跺紓甯革紝鏌ヨ鏉′欢:"+text+",澶х被:"+btype+",灏忕被锛�"+stype+";"+e.getMessage());
			e.printStackTrace();
			return null;
		} finally {
			try {
				reMgr.release(is);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}
	/**
	 * 鏌ヨ
	 * 
	 * 鏌ヨ鏃秙earch濡傛灉浣跨敤瀹屾垚锛岄渶瑕佸皢search閲婃斁浼歴earchFactory涓紝浣跨敤reMgr銆俽elease(indexSearcher)
	 * 杩涜閲婃斁 text 鎼滅储瀛楁 bigtype 涓诲ぇ绫� subtype 灏忕被鍚嶇О page 褰撳墠椤� pageSize 姣忛〉琛屾暟
	 * **/
	public Map<String, Object> search(String text, String sweiName,int btype,int mtype,int stype,Double startprice,Double endprice,
			String where,String wheretype,String marketId,int brandid, Integer page, Integer pageSize) {
		IndexSearcher is = getSearcher();
		try {
			Map<String, Object> map = new HashMap<String, Object>();
			// ----------璁剧疆杩囨护鍣�------------------------------------------------
			BooleanQuery booleanquery = new BooleanQuery();
			BooleanQuery hitQuery= new BooleanQuery();
			// 缁煎悎鏌ヨ 锛堟煡璇㈡潯浠�1锛�
//			String[] strs=text.split(" ");
//			for(int i=0;i<strs.length;i++)
//			{
//				if(i==0)
//				{
//					if(" ".equals(strs[i]))
//						continue;
//					Query likequery = new TermQuery(new Term("content", strs[i]));
//					MyCustomScoreQuery myQuery = new MyCustomScoreQuery(likequery);
//					booleanquery.add(myQuery, Occur.MUST);
//					hitQuery.add(myQuery, Occur.MUST);
//				}
//				if(" ".equals(strs[i]))
//					continue;
//				Query likequery = new FuzzyQuery(new Term("content", strs[i]));
//				MyCustomScoreQuery myQuery = new MyCustomScoreQuery(likequery);
//				booleanquery.add(myQuery, Occur.SHOULD);
//				hitQuery.add(myQuery, Occur.SHOULD);
//			}
			if(stopWordSet == null || stopWordSet.size()<=0)
				 initStopWord();
			//鍒涘缓鍒嗚瘝瀵硅薄  
	        StringReader sr=new StringReader(text);    
	        IKSegmenter ik=new IKSegmenter(sr, false);    
	        Lexeme lex=null;    
	        //鍒嗚瘝  
	        
	        if(text.length()>0)
	        {
	        	Query squery= new TermQuery(new Term("content",text));	
	        	hitQuery.add(squery, Occur.SHOULD);
	        	squery.setBoost(1000000.0f);
	        	booleanquery.add(squery, Occur.SHOULD);
	        	
		        while((lex=ik.next())!=null){  
		            //鍘婚櫎鍋滅敤璇�  
		            if(stopWordSet.contains(lex.getLexemeText())) {  
		                continue;  
		            }  
		            Query likequery = new TermQuery(new Term("content",lex.getLexemeText()));
		            hitQuery.add(likequery, Occur.SHOULD);
		            if(!text.equals(lex.getLexemeText()))
		            	likequery.setBoost(0.0f);
					booleanquery.add(likequery, Occur.SHOULD);
					   
		        }   
	        }
	        else
	        {
	        	Query likequery= new WildcardQuery(new Term("content","*"));
	        	booleanquery.add(likequery,Occur.MUST);
	        }
	        
	        
	        //搴楅摵鎼滅储
	        if(sweiName!=null &&!"".equals(sweiName)&&sweiName.length()>0)
	        {
	        	Query likequery = new TermQuery(new Term("supWeiName",sweiName));
				booleanquery.add(likequery, Occur.SHOULD);
				hitQuery.add(likequery, Occur.SHOULD);  
	        }
			
//			for(String str:strs)
//			{
//				if(" ".equals(str))
//					continue;
//				Query likequery = new FuzzyQuery(new Term("content", str));
//				MyCustomScoreQuery myQuery = new MyCustomScoreQuery(likequery);
//				booleanquery.add(myQuery, Occur.SHOULD);
//			}
//			Query likequery = new FuzzyQuery(new Term("content", text));
//			MyCustomScoreQuery myQuery = new MyCustomScoreQuery(likequery);
//			booleanquery.add(myQuery, Occur.MUST);
	        
	        if(startprice !=null || endprice !=null)
	        {
	        	if(startprice==0.0 || endprice==0.0)
	        	{
	        		
	        	}
	        	else
	        	{
		        	if(startprice == null)
		        		startprice=0.0;
		        	if(endprice == null)
		        		endprice = 0.0;
		        	Query subquery = NumericRangeQuery.newDoubleRange("defaultPrice", startprice,  endprice, true, true);
					booleanquery.add(subquery, Occur.MUST);
	        	}
	        }

			// 涓�绾у垎绫� 锛堟煡璇㈡潯浠�2锛�
			if (btype > 0) {
				Query subquery = NumericRangeQuery.newIntRange("btypeid", btype,  btype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			// 浜岀骇鍒嗙被
			if (mtype > 0) {
				Query subquery = NumericRangeQuery.newIntRange("mtypeid", mtype,  mtype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if(stype>0)
			{
				Query subquery = NumericRangeQuery.newIntRange("stypeid", stype,  stype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if(brandid>0)
			{
				Query subquery = NumericRangeQuery.newIntRange("brandid", stype,  stype, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			//鏌ヨ甯傚満id
			if (marketId.length() > 0) {
				Query subquery = NumericRangeQuery.newIntRange("marketId", Integer.parseInt(marketId),  Integer.parseInt(marketId), true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if("yu".equals(wheretype)) //鏀寔棰勫畾
			{
				Query subquery = NumericRangeQuery.newIntRange("yu",1,  1, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			if("pi".equals(wheretype)) //鏀寔鎵瑰彂
			{
				Query subquery =  NumericRangeQuery.newIntRange("pi",1,  1, true, true);
				booleanquery.add(subquery, Occur.MUST);
			}
			
			
//			TopDocs tds = is.search(booleanquery, 2000000);
			// -------------鎼滅储--------------------------------------------------------
			// 鍒嗛〉鏌ヨ,lucene涓嶆敮鎸佸垎椤垫煡璇紝鍥犱负鏌ヨ閫熷害寰堝揩锛屾墍浠ユ垜浠氨璁剧疆鏌ヨ涓婇檺
//			TopScoreDocCollector topCollector = TopScoreDocCollector.create(
//					page * pageSize, false);// 涓婇檺
			
//			Sort sort =new Sort(new SortField("clickPoint", Type.LONG, true));
			//ture 鍊掑簭  false 鍗囧簭
//			Sort sort = new Sort();//鍒涘缓鎺掑簭
//			SortField sortf = new SortField("createTime", FieldCache.DEFAULT_LONG_PARSER, true); 
			SortField sortf=new SortField("createTime", SortField.Type.INT, true);
//			SortField sortf=new SortField("defaultPrice", SortField.Type.DOUBLE, false);//鎺掑簭瑙勫垯
			if("aprice".equals(where)) //鎺掑簭浠锋牸鐢变綆鍒伴珮
			{
				sortf=new SortField("defaultPrice", SortField.Type.DOUBLE, false);//鎺掑簭瑙勫垯
			}
			if("dprice".equals(where)) //鎺掑簭浠锋牸鐢遍珮鍒�
			{
				sortf=new SortField("defaultPrice", SortField.Type.DOUBLE, true);//鎺掑簭瑙勫垯
			}
			 if("dcreatetime".equals(where))//鎺掑簭鏃堕棿鐢辨柊鍒版棫
			{
				 sortf=new SortField("createTime", SortField.Type.INT, true);
			}
			 if("acreatetime".equals(where))//鎺掑簭鏃堕棿鐢辨棫鍒版柊
			{
				 sortf=new SortField("createTime", SortField.Type.INT, false);
			}
			 if("dcount".equals(where))
			 {
				 sortf=new SortField("totalCount", SortField.Type.INT, true);
			 }
			 if("acount".equals(where))//鏁伴噺鐢变綆鍒伴珮
			 {
				 sortf=new SortField("totalCount", SortField.Type.INT, false);
			 }
			 if("acommision".equals(where)) //鎺掑簭浠锋牸鐢变綆鍒伴珮
			{
				sortf=new SortField("defaultCommision", SortField.Type.DOUBLE, false);//鎺掑簭瑙勫垯
			}
			if("dcommision".equals(where)) //鎺掑簭浠锋牸鐢遍珮鍒�
			{
				sortf=new SortField("defaultCommision", SortField.Type.DOUBLE, true);//鎺掑簭瑙勫垯
			}
//			SortField sortf=new SortField("totalCount", SortField.Type.INT, false);
			
//			sort.setSort(sortf);
			Sort sort = new Sort(new SortField[]{new SortField(null,SortField.Type.SCORE,false),sortf});  
			TopDocs topDocs = is.search(booleanquery, 2000000,sort);  // 鎼滅储鐩镐技搴︽渶楂樼殑N鏉¤褰�
//			is.search(booleanquery, topCollector);
			// 鏌ヨ缁撴灉鐨勬�绘暟閲�
//			int totalNum = topCollector.getTotalHits();
			int totalNum=topDocs.totalHits;
			map.put("totalCount", totalNum);
			map.put("totalPage", totalNum / pageSize
					+ (totalNum % pageSize == 0 ? 0 : 1));
			map.put("pageIndex", page);
			map.put("pageSize", pageSize);
			
//			ScoreDoc[] docs = topCollector.topDocs((page - 1) * pageSize,
//					pageSize).scoreDocs;// 杩斿洖鎵�闇�鏁版嵁
			ScoreDoc[] docs = topDocs.scoreDocs;
			QueryScorer qs= new QueryScorer(hitQuery); 
			//璁剧疆楂樹寒鏍囩
	        Formatter formatter = new SimpleHTMLFormatter("<font color='red'>", "</font>");
	         //楂樹寒鍒嗘瀽鍣�
	        Highlighter hl = new Highlighter(formatter, qs);
	         
	         Fragmenter fragmenter = new SimpleSpanFragmenter(qs);
	         hl.setTextFragmenter(fragmenter);
			ArrayList<SearchProductInfo> list = new ArrayList<SearchProductInfo>();
			SearchProductInfo data = null;
//			for (ScoreDoc scdoc : docs) {
			//鏌ヨ璧峰璁板綍浣嶇疆
	        int begin = pageSize * (page - 1);	 
	        int end = Math.min(begin + pageSize, docs.length);
			for (int i = begin; i < end; i++) {
				ScoreDoc scdoc=docs[i];
				Document document = is.doc(scdoc.doc);
				data = new SearchProductInfo();
				// 璁剧疆楂樺３
				String outline = document.get("content");

				try {
					outline=hl.getBestFragment(AnalyzerUtil.getIkAnalyzer(), "content",outline);
				} catch (InvalidTokenOffsetsException e) {
					e.printStackTrace();
				}
				if (outline == null)
					outline = document.get("content");
				PProducts pp=service.getPProductsById(Long.parseLong(document.get("id")));	
				if(pp==null)
					continue;
				data.setEndPrice(Double.parseDouble(document.get("endPrice")));
				data.setStartPrice(Double.parseDouble(document.get("startPrice")));	
				data.setTitle(outline);				
				data.setImage(ImgDomain.GetFullImgUrl(pp.getDefaultImg(), 24));
				data.setKeyWord(text);
				data.setProductId(pp.getProductId());
				String supType=document.get("supType");
				data.setSupType(supType);
				data.setSupWeiId(pp.getSupplierWeiId());
				String supName=service.getSupWeiName(pp.getSupplierWeiId());
				if("".equals(supName))
					data.setSupWeiName(document.get("supWeiName"));
				else
					data.setSupWeiName(supName);
				int yu = ParseHelper.toInt(document.get("yu"),0);
				List<String> ls = new ArrayList<String>();
				if (yu==1) {
					ls.add("http://base3.okimgs.com/images/1-3-1_07.png"); //棰�
				} 
				int pi = ParseHelper.toInt(document.get("pi"),0);
				if (pi==1) {
					ls.add("http://base3.okimgs.com/images/1-3-1_09.png");//鎵�
				}				
				data.setImages(ls);	
				Short shtype=(short)0;
				if(!"".equals(supType))
					shtype=Short.parseShort(supType);
				String supTypeimg="";
				if(BitOperation.getIntegerSomeBit(shtype,2)==1)
				{
					
					supTypeimg="http://base3.okimgs.com/images/1-3-1_1322.png";
				}
				if(BitOperation.getIntegerSomeBit(shtype,1)==1)
				{
					supTypeimg="http://base3.okimgs.com/images/1-3-1_03.png";
				}
				data.setSupTypeImg(supTypeimg);
				list.add(data);
			}
			map.put("spList", list);
			return map;
		} catch (IOException e) {
			logger.error("Lucene鏌ヨ鏃跺紓甯革紝鏌ヨ鏉′欢:"+text+",澶х被:"+btype+",灏忕被锛�"+stype+";"+e.getMessage());
			e.printStackTrace();
			return null;
		} finally {
			try {
				reMgr.release(is);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}

	}





	/** 浣跨敤鍗曚緥鑾峰彇IndexSearch **/
	public IndexSearcher getSearcher() {
		IndexSearcher is = null;
		try {
			if (is == null) {
				reMgr.maybeRefresh();// 鍒锋柊reMgr,鑾峰彇鏈�鏂扮殑IndexSearcher
				is = reMgr.acquire();

			}
		} catch (IOException e) {
			e.printStackTrace();
		}
		if (is == null) {
			logger.error("Lucene鍒濆鍖朓ndexSearcher鏃跺紓甯�");
			throw new RuntimeException("indexSearcher is null!!!!");
		}
		return is;

	}

	/**
	 * 鍏抽棴鍒濆鍖栫嚎绋嬬殑澶勭悊
	 */
	public void close() {
		// stop the re-open thread
		//鍏抽棴娴�  
		crt.interrupt();
		crt.close();
		
		// close the indexWriter,commit 鎵�鏈夋湁杩囦慨鏀圭殑鍐呭
		try {
			writer.commit();
			writer.close();
			
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

}
